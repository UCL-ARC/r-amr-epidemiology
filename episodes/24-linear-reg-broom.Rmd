---
title: "Linear Regression and Broom"
teaching: 60
exercises: 20
source: Rmd
---

::::::::::::::::::::::::::::::::::::::: objectives

- To be able to explore relationships between variables
- To be able to calculate predicted variables and residuals 
- To be able to construct linear regression models
- To be able to check assumptions for linear regressiona models
- To be able to present model outcomes using Broom

::::::::::::::::::::::::::::::::::::::::::::::::::

:::::::::::::::::::::::::::::::::::::::: questions

- How can I explore relationships between variables in my data?
- How can I check that my data is suitable for use in a linear regression model?
- How can I present model outputs in an easier to read way?

::::::::::::::::::::::::::::::::::::::::::::::::::

## Content

-   Linear Regression Models
-   Use of Logit
-   Assumption Diagnostics and Regression Troubleshooting 
-   Use of Broom

## Data

```{r libraries, message=FALSE, warning=FALSE}

# We will need these libraries and this data later.
library(ggplot2)
library(lmtest)
library(sandwich)

lon_dims_imd_2019 <- read.csv(".data/English_IMD_2019_Domains_rebased_London_by_CDRC.csv")

```

We are going to use the data from the Consumer Data Research Centre, specifically the London IMD 2019 (English IMD 2019 Domains rebased).

Atribution: Data provided by the Consumer Data Research Centre, an ESRC Data Investment: ES/L011840/1, ES/L011891/1 

The statistical unit areas across the country are Lower layer Super Output Areas (LSOAs). We will explore the relationships between the different dimensions of the Indices of Multiple Deprivation.

## Linear Regression

Linear Regression enables use to to explore the the linear relationship of the dependent variable Y and independent variable(s) X(s). 
We are going to explore the linear relationship between the Health Deprivation and Disability Domain and the Living Environment Deprivation Domain.

The Health Deprivation and Disability Domain measures the risk of premature death and the impairment of quality of life through poor physical or mental health. The domain measures morbidity, disability and premature mortality but not aspects of behaviour or environment that may be predictive of future health deprivation.

The Living Environment Deprivation Domain measures the quality of the local environment. The indicators fall into two sub-domains. The ‘indoors’ living environment measures the quality of housing; while the ‘outdoors’ living environment contains measures of air quality and road traffic accidents.

Reference: 
  McLennan, David et al. The English Indices of Deprivation 2019 : Technical Report. Ministry of Housing, Communities and Local Government, 2019. Print.


### Simple Linear Regression
In the simple linear regression example we have only one dependent variable (health_london_rank) and one independent variable (livingEnv_london_rank).

```{r}

reg_LivEnv_health <- lm(health_london_rank ~ livingEnv_london_rank, data = lon_dims_imd_2019)
# We put the dependent variable to the left of the '~' and the independent variable(s) to the right 
# and we tell R which dataset we are referring to.

summary(reg_LivEnv_health)

```

From the result of this analysis, we can see that the Living Environment Deprivation Domain rank has a significant(small p-value, general rule of thumb <0.05) and positive relationship(positive coefficient) with the Health Deprivation and Disability Domain rank.

One way of interpreting the result is: One unit increase in the Living Environment rank is related to around 0.343 (3.430e-01) points increase of the Health Deprivation and Disability rank. 

R-square shows the amount of variance of Y explained by X. In this case the Living Environment rank explains 6.225% of the variance in the Health Deprivation and Disability rank. Adj R2(6.205%) shows the same as R2 but adjusted by the # of cases and # of variables. When the # of variables is small and the # of cases is very large then Adj R2 is closer to R2.

### Logit

Don't know what to put here yet

### Predicted values and Residuals

We can expand our simple linear regression example to incorporate the Barriers to Housing and Services Domain rank.
The Barriers to Housing and Services Domain measures the physical and financial accessibility of housing and local services. The indicators fall into two sub-domains: ‘geographical barriers’, which relate to the physical proximity of local services, and ‘wider barriers’ which includes issues relating to access to housing, such as affordability.

```{r}

reg_LivEnv_barriers_health <- lm(health_london_rank ~ livingEnv_london_rank + barriers_london_rank, data = lon_dims_imd_2019)

summary(reg_LivEnv_barriers_health)

```

After running the regression model, we can access the model predicted values and the residuals compared to the real observations.

```{r}
#first we fit the predictions
health_rank_pred<-fitted(reg_LivEnv_barriers_health)
health_rank_pred<-as.data.frame(health_rank_pred)

#now we add the residual values too
health_rank_resid<-residuals(reg_LivEnv_barriers_health)
health_rank_pred$resid<-health_rank_resid

#We can thenview the predictions and residuals
View(health_rank_pred)
```

### Robust Regression

We can run the robust standard error regressions(control for heteroskedasticity, meaning unequal variances):

```{r}
reg_LivEnv_barriers_health$robse <- vcovHC(reg_LivEnv_barriers_health, type="HC1")
coeftest(reg_LivEnv_barriers_health,reg_LivEnv_barriers_health$robse) 
```

In addition,  we can access the cluster-robust standard errors regression results:

```{r}
#cluster-robust standard errors
coeftest(reg_LivEnv_barriers_health, reg_LivEnv_barriers_health$clse) 
```

