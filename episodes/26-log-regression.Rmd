---
title: "Logistic Regression"
teaching: 60
exercises: 30
source: Rmd
---

::::::::::::::::::::::::::::::::::::::: objectives

- To be able to construct regression models for a binary outcome
- To be able to calculate predicted variables and residuals 
- To be able to present model outcomes using Broom

::::::::::::::::::::::::::::::::::::::::::::::::::

:::::::::::::::::::::::::::::::::::::::: questions

- How can I identify factors for antibiotic resistance?
- How can I check the validity of model?

::::::::::::::::::::::::::::::::::::::::::::::::::

## Content

-   Exploratory Data Analysis
-   Model Creation and Estimation
-   Assumption Testing
-   Report the Logistic Regression Results

## Data

```{r libraries, message=FALSE, warning=FALSE}

# We will need these libraries and this data later.
library(table1)
library(finalfit)
library(aod)
library(ggplot2)
library(tidyverse)
library(lubridate)
library(knitr)
library(odds.n.ends)

amrData <- read.csv("data/dig_health_hub_amr.csv")

```
The data used in this episode was provided by Simon Thelwall from the UKHSA. 
It has been created to represent the sort of data that might be obtained from the Second Generation Surveillance System (SGSS).
The data has 100,000 rows of 12 variables.

## Exploratory Data Analysis

We can preview our data by using 'head':

```{r}

head(amrData)

```
We can also request information about variable names and data types:
```{r}

sapply(amrData, class)

```

We can see that dates are currently stored as the char data type. We also do not know the age of the participant when the sample was taken.

```{r}

# Calculate age (in years) as of their last birthday and add as an additional variable to our data.

amrData <- amrData %>% 
  mutate(
    age_years_sd = (dob %--% spec_date) %/% years(1)
  )

```

We can also convert 'spec_date', the date the specimen was taken from text to a date:
```{r}

# Convert char to date and store as additional variable
amrData <- amrData %>% 
  mutate(
    spec_date_YMD = as.Date(amrData$spec_date)
  )

```
We can use a histogram to explore the age distribution of the participants:

```{r}
# histogram of age
ageHisto <- amrData %>%
  ggplot(aes(x = age_years_sd)) +
  geom_histogram(bins = 10, color = 'white') +
  theme_minimal(base_size = 14, base_family = "sans") +
  labs(x = "Age when specimen taken (years)", y = "Frequency")
ageHisto

```
We can also look at where the specimens were processed:
```{r}

xtabs(~region, data=amrData)

```

and for which organism:
```{r}

xtabs(~organism, data=amrData)

```

In addition, we can use cross-tabulation to identify if the specimen indicated resistance to one or more of Coamoxiclav, Gentamicin and Ciprofloxacin for the participants:

```{r}

xtabs(~coamox+cipro+gentam, data=amrData)

```
We can see from our table that only 227 participants indicated reistance to Coamoxiclav, Gentamicin and Ciprofloxacin.
Coamoxiclav appears to have the highest individual indication of resistance. We will explore indicators to Coamoxiclav first.

##  Model Creation and Estimation

As the dependent variable we want to explore is binary (0,1), we will use a binomial generalised linear model.


```{r}

coamox_logit <- glm(coamox ~ age_years_sd + sex_male, data = amrData, family= 'binomial')

summary(coamox_logit)

```
In this initial model focusing on demographic indicators, age at time of sample being taken and whether or not the participant is male both seem to be statistically significant.

age_years_sd: For every unit increase in age_years_sd the log-odds of Coamoxiclav resistance increase by 0.0404280.

sex_male: The difference in the log-odds of Coamoxiclav resistance between males and non-males is 0.0540494.

Older participants and male participants have higher log-odds of Coamoxicalv resistance.

We can check to see that our indicators sex_male and age_years_sd are independent:
```{r}
# check VIF for no perfect multicollinearity assumption
car::vif(coamox4_logit)
```
We can also check the linearity of the variable age_years_sd

```{r}
# make a variable of the logit of the predicted values
logit.use <- log(coamox_logit$fitted.values/(1-coamox_logit$fitted.values))

# make a small data frame with the logit variable and the age predictor
linearity.data <- data.frame(logit.use, age = coamox_logit$model$age_years_sd)

# create a plot with linear and actual relationships shown
linearPlot <- linearity.data %>%
  ggplot(aes(x = age, y = logit.use))+
  geom_point(aes(size = "Observation"), color = "blue", alpha = .6) +
  geom_smooth(se = FALSE, aes(color = "Loess curve")) + 
  geom_smooth(method = lm, se = FALSE, aes(color = "linear")) + 
  theme_minimal(base_size = 14, base_family = "serif") +
  labs(x = "Age in years on sample date", y = "Log-odds of coamox resistance predicted probability") +
  scale_color_manual(name="Type of fit line", values=c("red", "black")) +
  scale_size_manual(values = 1.5, name = "")

linearPlot

```

::::::::::::::::::::::::::::::::::::::  challenge

### Challenge 1

Update the model coamox_logit to include had_surgery_past_yr as an independent variable.
What is the log-odds reported and is it statistically significant?

:::::::::::::::  solution

### Challenge 1

You may choose to create a new glm:

```{r}
coamox_surg_logit <- glm(coamox ~ age_years_sd + sex_male + had_surgery_past_yr, data = amrData, family= 'binomial')

summary(coamox_surg_logit)
```
had_surgery_past_yr: The difference in the log-odds of Coamoxiclav resistance between those who have had surgery in the past year
and those who have not is 0.1802123. It is statistically significant.

You may also want to check for culticollinearity:

```{r}
car::vif(coamox_surg_logit))
```
As the value of GVIF is lower than 4, it suggests that the assumption of independnce between the variables is held.

:::::::::::::::::::::::::

::::::::::::::::::::::::::::::::::::::::::::::::::

### Incorporating a multi-level factor
