---
title: SQL and R
teaching: 60
exercises: 15
source: Rmd
---

::::::::::::::::::::::::::::::::::::::: objectives

- Understand the value of writing reproducible reports
- Learn how to recognise and compile the basic components of an Quarto file
- Become familiar with R code chunks, and understand their purpose, structure and options
- Demonstrate the use of inline chunks for weaving R outputs into text blocks, for example when discussing the results of some calculations
- Be aware of alternative output formats to which a Quarto file can be exported

::::::::::::::::::::::::::::::::::::::::::::::::::

:::::::::::::::::::::::::::::::::::::::: questions

- How can I work with relational data?
- How can I extract data given a specific criteria?
- How can I join related data sets?

::::::::::::::::::::::::::::::::::::::::::::::::::

:::::::::::::::::::::::::::::::::::::::: content

- Relational Databases - an overview
- Creating a SQLite database
- Selecting data
- Filtering data
- Joining data
- Calculated fields

::::::::::::::::::::::::::::::::::::::::::::::::::

## Relational Databases - an overview

In this episode we will be using SQLite, a Relational Database Management Systems (RDBMS) within R.
We have chosen SQLite as it is an embedded RDBMS and does not rely on a connection to a server. 
It uses most of the SQL standard, and it is fully ACID compliant.

### What is SQL?

Structured Query Language, or SQL (sometimes pronounced "sequel"), is a powerful language used to interrogate and manipulate relational databases. It is not a general programming language that you can use to write an entire program. However, SQL queries can be called from programming languages to let any program interact with databases. There are several variants of SQL, but all support the same basic statements that we will be covering today.

### Relational databases

Relational databases consist of one or more tables of data. These tables have fields (columns) and records (rows). Every field has a data type. Every value in the same field of each record has the same type. These tables can be linked to each other when a field in one table can be matched to a field in another table. SQL queries are the commands that let you look up data in a database or make calculations based on columns.

### Why use SQL?

SQL is well established and has been around since the 1970s. It is still widely used in a variety of settings.

SQL lets you keep the data separate from the analysis. There is no risk of accidentally changing data when you are analysing it. If the data is updated, a saved query can be re-run to analyse the new data.

SQL is optimised for handling large amounts of data. Data types help quality control of entries - you will receive an error if you try to enter a word into a field that should contain a number.

## Creating a SQLite database

For creating and querying a SQLite database in R we will be using 2 additional packages, RSQLite and DBI.

```{r}
# As RSQLite uses functions defined in the DBI package, we load DBI first

library(DBI)
library(RSQLite)

```

We will be using data from the Consumer Data Research Centre (CDRC), the Access to Healthy Assets & Hazards (AHAH) from 2022 
and the UK Indices of Multiple Deprivation data from 2019. 
The statistical unit area used in both are Lower layer Super Output Areas (LSOAs).

```{r}
# Import data initially to dataframes 
ahah_2022 <- read.csv('data/AHAH_V3_0.csv')
imd_2019 <- read.csv('data/uk_imd2019.csv')

```
We can now connect to SQLite and create a new empty database:

```{r}

cdrcDB <- dbConnect(RSQLite::SQLite(), "cdrcDB.sqlite")

cdrcDB

```

and start adding our tables:

```{r}
#create tables

dbWriteTable(cdrcDB, "ahah", ahah_2022)
dbWriteTable(cdrcDB, "imd", imd_2019)

dbListTables(cdrcDB)

```

There a few ways we can inspect our data.

We can view the Fields in a table:

```{r}
dbListFields(cdrcDB,"ahah")
```

We can also return the dimensions of our tables utilising loops:

```{r}

for (t in dbListTables(cdrcDB)) {
  rows <- dbGetQuery(cdrcDB, paste("SELECT COUNT(*) FROM", t))
  cols <- length(dbListFields(cdrcDB, t))
  print(paste(t, "-", rows, "x", cols))
}

```
